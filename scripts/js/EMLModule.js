var ErrorSeverity;!function(e){e[e.High=1]="High",e[e.Medium=2]="Medium",e[e.Low=3]="Low",e[e.Zero=4]="Zero"}(ErrorSeverity||(ErrorSeverity={}));var ErrorType;!function(e){e[e.Fix=1]="Fix",e[e.BestPractice=2]="BestPractice",e[e.Suggestion=3]="Suggestion",e[e.Warn=4]="Warn"}(ErrorType||(ErrorType={}));var errorObject=function(){function e(e,t,r,i){void 0===i&&(i={}),this.type=e,this.cleanType=ErrorType[e],this.title=t,this.description=r,this.handler=void 0===i.handler?function(){}:i.handler,this.ctaLabel=void 0===i.ctaLabel?"":i.ctaLabel,this.severity=void 0===i.severity?ErrorSeverity.Zero:i.severity}return e}(),MailtoLinkObject=function(){function e(e){this.parent=e,this.email="",this.subject="",this.body="",this.parent.isLinkType("mailto")&&this.initEmailEditor()}return e.prototype.has=function(e){return this.updateMailtoObj(),this[e]&&""!==this[e].trim()},e.prototype.isValidEmailAddress=function(){return this.parent.emailRegex.test(this.email)},e.prototype.deinitEmailEditor=function(){this.email="",this.subject="",this.body=""},e.prototype.composeEmail=function(){this.parent["new"].url="mailto:"+this.email;for(var e=["subject","body"],t=0;t<e.length;t++)this[e[t]]&&""!==this[e[t]]&&this.parent["new"].searchParams.set(e[t],this[e[t]])},e.prototype.updateMailtoObj=function(){var e=this,t=this.parent["new"].url.substr(7,this.parent["new"].url.length-7),r=t.split("?");this.email=r[0],this.parent["new"].searchParams.updateEntries(),r.length>1&&["subject","body"].forEach(function(t){e.parent["new"].searchParams.has(t)&&(e[t]=window.decodeURIComponent(e.parent["new"].searchParams.get(t)))})},e.prototype.inputOnBlur=function(){this.parent["new"].searchParams.updateEntries(),this.parent["new"].searchParams.updateSearchProp()},e.prototype.openEditor=function(){this.initEmailEditor(),window.jQuery("html,body").animate({scrollTop:window.jQuery("#link-"+this.parent.id).offset().top-75},300);var e=this.parent;setTimeout(function(){window.jQuery("#link-"+e.id).find(".mailtoEditor").popup("show")},400)},e.prototype.initEmailEditor=function(){this.updateMailtoObj()},e}(),URLObj=function(){function e(e){this.href="",this.search="",this.origin="",this.hash="",this.protocol="",this.url=e,this.searchParams=new URLObjSearchParams(this)}return e.prototype.prepareExport=function(){},e.prototype.contains=function(e){return this.url.indexOf(e)>-1},Object.defineProperty(e.prototype,"url",{get:function(){return this.prepareExport(),this.origin+this.search+this.hash},set:function(e){this.search="",this.hash="";var t=/^(https?|mailto|ftp)\:/gi;if(t.test(e)){var r=e.match(t);this.protocol=r[0]}if(this.href=e,"#"==e.trim())this.hash="#";else if(e.trim().length>1&&e.indexOf("#")>-1){var i=e.split("#");this.hash="#"+i.pop();var s=i.join("#").split("?");this.origin=s[0],this.search=s.length>0?"?"+s[1]:""}else if(e.indexOf("?")>-1){var s=e.split("?");this.origin=s[0],this.search=s.length>0?"?"+s[1]:""}else this.origin=e},enumerable:!0,configurable:!0}),e}(),URLObjSearchParams=function(){function e(e){this.parent=e,this.parent.search.length>0?this._entries=this.parent.search.substr(1,this.parent.search.length).split(/\&amp\;|\&/g):this._entries=[]}return Object.defineProperty(e.prototype,"entries",{get:function(){for(var e=[],t=0;t<this._entries.length;t++){var r=this._entries[t].split("=");r.length>1&&(r[1]=decodeURIComponent(r[1])),e.push(r.join("="))}return e},enumerable:!0,configurable:!0}),e.prototype.updateEntries=function(){if(this._entries=[],"?"!==this.parent.search&&this.parent.search.length>1)for(var e=this.parent.search.substr(1,this.parent.search.length).split(/\&amp\;|\&/g),t=0;t<e.length;t++)this._entries.push(e[t])},e.prototype.updateSearchProp=function(){for(var e=[],t=0;t<this._entries.length;t++){var r=this._entries[t].split("=");/[a-z]{1,4}=(.*?:){3,9}/gi.test(this._entries[t])?e.push(this._entries[t]):e.push(r[0]+(r.length>1?"="+encodeURIComponent(decodeURIComponent(r[1])):""))}this.parent.search=e.length>0?"?"+e.join("&"):""},e.prototype.has=function(e){for(var t=new RegExp("^"+e+"=","g"),r=!1,i=0;i<this._entries.length;i++)t.test(this._entries[i])&&(r=!0);return r},e.prototype.get=function(e){for(var t=new RegExp("^"+e+"=","g"),r=!1,i=0;i<this._entries.length;i++)t.test(this._entries[i])&&(r=this._entries[i].split("=").pop());return r},e.prototype.set=function(e,t){for(var r=new RegExp("^"+e+"=","g"),i=!1,s=0;s<this._entries.length;s++)r.test(this._entries[s])&&(this._entries[s]=e+"="+t,i=!0);i||this.append(e+"="+t),this.updateSearchProp()},e.prototype.append=function(e){this._entries.push(e),this.updateSearchProp()},e.prototype.deleteAll=function(){this._entries=[],this.updateSearchProp()},e.prototype.deleteAtIndex=function(e){this._entries.splice(e,1),this.updateSearchProp()},e.prototype["delete"]=function(e){for(var t=0;t<this._entries.length;t++)this._entries[t].substr(0,e.length+1)==e+"="&&this.deleteAtIndex(t)},e}(),LinkObject=function(){function e(e,t,r){var i=this;this.__isComplete=!1,this._super=r,this.__requiresTrackingCodeRegExp=RegExp("^http(s)?://(.*?)?optum(.*?)?.co[m.]?"),this.__requiredTrackingCodeWhitelist=[".pdf",".ics",".oft","optumsurveys.co","healthid.optum.com","learning.optum.com","app.info.optum.com","optum.webex.com","twitter.com","facebook.com","linkedin.com","info.optum"],this.line=e+1,this.context=t,this.queryStrings=[],this.errors=[],this.id=0,this.whiteListedUrl="~~whitelist~~",this.urlRegex=/^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[\/?#]\S*)?$/i,this.emailRegex=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;var s=/href\=\"([^\"\>]*)\"/g,n=t.match(s);if(n.length>0&&('href=""'==n[0]?(i["new"]=new URLObj("#"),i.old=new URLObj("#"),this.context=this.context.replace(new RegExp('href=""',"g"),'href="#"')):(i["new"]=new URLObj(n[0].substr(6,n[0].length-7).trim()),i.old=new URLObj(n[0].substr(6,n[0].length-7).trim()))),/src=\"(.*?)\"/.test(t)){var a=t.match(/src=\"(.*?)\"/);a.length>0&&(console.log("image found"),i.linkImage=a[1])}this.mailto=new MailtoLinkObject(this),this.isLinkComplete()}return e.prototype.hasDuplicateQueryStrings=function(){var e=[],t=[];if(this["new"].searchParams.entries.length>0)for(var r=0,i=this["new"].searchParams.entries;r<i.length;r++){var s=i[r],n=s.split("=").shift();t.indexOf(n)>-1&&e.push(n),t.push(n)}return e.length>0&&e},e.prototype.hasQueryStringParameter=function(e){return console.warn("hasQueryStringParameter has depreciated, use the relevant URLObjSearchParams method"),this["new"].searchParams.has(e)},e.prototype.removeJumpLink=function(){this["new"].hash="",this.isLinkComplete()},e.prototype.overrideTrackingRequirements=function(){this.whiteListedUrl=this["new"].url},e.prototype.displayFormattedURL=function(){var e=this.context,t='href="',r=e.indexOf(t);return e=e.replace(new RegExp('href=""',"g"),'href="#"'),e=e.substr(0,r)+t+"|||+++|||"+e.substr(r+(t.length+this.old.url.length),e.length),e=e.replace(new RegExp('"',"g"),"&quot;"),e=e.replace(new RegExp("/","g"),"&#47;"),e=e.replace(new RegExp(">","g"),"&gt;"),e=e.replace(new RegExp("<","g"),"&lt;"),e=e.replace(/([^\s]*?)\=/g,'<span class="attr">$1</span><span class="keyword">=</span>'),e=e.replace(/\&quot\;\&gt\;/g,'&quot;<span class="tag">&gt;</span>'),e=e.replace(/\&\#47\;\&gt\;/g,'<span class="tag">&#47;&gt;</span>'),e=e.replace(/\&quot\;(.*?)\&quot\;/g,'<span class="value">"$1"</span>'),e=e.replace(/\&lt\;([a-z]+\s?)/g,'<span class="tag">&lt;$1</span>'),e=e.replace(/\&lt\;\&\#47\;([a-z]+\s?)\&gt\;/g,'<span class="tag">&lt;&#47;$1&gt;</span>'),e=e.replace(/\&gt\;/g,'<span class="tag">&gt;</span>'),e=e.replace(/\|\|\|\+\+\+\|\|\|/g,"<strong>"+(this.hasOwnProperty("deleteOnRender")&&this.deleteOnRender?this.old.url:this["new"].url)+"</strong>")},e.prototype.isLinkComplete=function(){return this._super.intelligence=EMLMakerAIEngine.CheckEmail(this._super),this.errors=EMLMakerAIEngine.CheckLink(this),this.__isComplete=this.errors.canContinue&&this._super.intelligence.canContinue,this.hasOwnProperty("deleteOnRender")&&this.deleteOnRender&&(this.__isComplete=!0),this.__isComplete},e.prototype.isLinkType=function(e){var t=!1;switch(e){case"http":"http:"!=this["new"].protocol&&"https:"!=this["new"].protocol||(t=!0);break;case"mailto":"mailto:"==this["new"].protocol&&(t=!0)}return t},e.prototype.hasTrackingCode=function(e){void 0===e&&(e=this["new"].url);var t=/[a-z]{1,4}=(.*?:){3,9}/gi;return t.test(e)},e.prototype.requiresTrackingCode=function(e){var t=!1;if(this.__requiresTrackingCodeRegExp.test(this["new"].url)){t=!0;for(var r=0;r<this.__requiredTrackingCodeWhitelist.length;r++)this.__requiredTrackingCodeWhitelist[r]instanceof RegExp?this.__requiredTrackingCodeWhitelist[r].test(this["new"].url)&&(t=!1):this["new"].url.indexOf(this.__requiredTrackingCodeWhitelist[r])>-1&&(t=!1)}return t},e.prototype.needsTrackingCode=function(){var e=this.requiresTrackingCode();return this.whiteListedUrl!=this["new"].url&&(this.hasTrackingCode()&&(e=!1),e)},e.prototype.refreshURL=function(){console.warn("refreshURL has depreciated, use the relevant URLObj method"),this.isLinkComplete()},e}(),EMLWorkspace=function(){function e(e,t){void 0===e&&(e=""),void 0===t&&(t="");this.buffer=null,this.scope=t,this.linksView="experimental",this.sourceCode=e,this.outputCode="",this.fileName="eml-maker-untitled",this.linkData=[],this.defaultScode="s=email",this.header={subject:""},this.messages=[],this.errors={messages:[],canProceed:!0},this.exportForEloqua="Yes",this.__emlHeaders="",this.keyBoardShortcuts=[],this.__allowableHeaderFields={to:{syntax:"To: ",label:"To",instructions:"A list of email addresses separated by commas."},subject:{syntax:"Subject: ",label:"Subject",instructions:""},cc:{syntax:"Cc: ",label:"CC",instructions:"A list of email addresses separated by commas."},replyto:{syntax:"Reply-to: ",label:"Reply to",instructions:"A list of email addresses separated by commas."}},this.headers=["X-Unsent: 1","Mime-Version: 1.0 (Mac OS X Mail 10.1 (3251))","X-Uniform-Type-Identifier: com.apple.mail-draft","Content-Transfer-Encoding: 7bit"]}return e.prototype.mapLinkObjects=function(e){if(this.linkData.length>0)for(var t=0;t<this.linkData.length;t++)e(this.linkData[t])},e.prototype.composeEML=function(){location.href="#/export-compose-eml"},e.prototype.downloadEml=function(){this.generateOutputCode(),this.outputCode=this.__replaceEloquaMergeFields(this.outputCode);var e=this.__emlHeaders+"\n\n"+this.__removeWhiteSpace(this.outputCode);this.fileName=this.__formatFileName(this.fileName),window.saveAs(new Blob([e],{type:"text/html"}),this.fileName+".eml"),window.ga("send","event","EML","download","EML Export"),location.href="#/export-eml"},e.prototype.downloadCsv=function(){var e="Context,Original URL,Modified URL\n";this.linkData.forEach(function(t){e+=t.context.replace(/,/g,"(comma)")+","+t.old.url+","+t["new"].url+"\n"}),this.fileName=this.__formatFileName(this.fileName),window.saveAs(new Blob([e],{type:"text/csv"}),this.fileName+"_links.csv"),window.ga("send","event","CSV","download","CSV Export")},e.prototype.downloadHtml=function(){this.generateOutputCode();var e=this.outputCode;this.fileName=this.__formatFileName(this.fileName),window.saveAs(new Blob([e],{type:"text/html"}),this.fileName+".html"),window.ga("send","event","HTML","download","HTML Export")},e.prototype.exportCodeToHTML=function(){var e=!1;this.exportForEloqua&&"Yes"==this.exportForEloqua?(this.mapLinkObjects(function(t){e=t.whiteListedUrl==t["new"].url,t.isLinkType("mailto")||t["new"].searchParams.has("elqTrack")||/app\.info\.optum\.com/gi.test(t["new"].url)||(t["new"].searchParams.append("elqTrack=true"),t.refreshURL(),e&&(t.whiteListedUrl=t["new"].url))}),window.ga("send","event","HTML","Add Eloqua Tracking","Add Eloqua Tracking")):this.mapLinkObjects(function(e){if(e["new"].searchParams.has("elqTrack")){var t=e["new"].searchParams.entries.indexOf("elqTrack=true");t>-1&&e["new"].searchParams.deleteAtIndex(t),e.refreshURL()}}),this.generateOutputCode(),window.ga("send","event","HTML","view sourcecode","Export/View HTML"),location.href="#/export-html"},e.prototype.setUpShortcutKeys=function(){var e=this;e.keyBoardShortcuts.push(["CTRL + SHIFT + 1","Remove all query strings from email"]),e.keyBoardShortcuts.push(["CTRL + SHIFT + 2","Add s=email to all links"]),e.keyBoardShortcuts.push(["CTRL + SHIFT + 3","Apply all suggestions"]),document.onkeyup=function(t){(t.ctrlKey||t.metaKey)&&t.shiftKey&&51==t.which?e.scope.$apply(function(){e.mapLinkObjects(function(e){e.errors.messages.length>0&&(e.errors.messages.forEach(function(t){t.type==ErrorType.Suggestion&&t.handler(e)}),e.isLinkComplete())})}):(t.ctrlKey||t.metaKey)&&t.shiftKey&&50==t.which?e.scope.$apply(function(){e.mapLinkObjects(function(e){e.readOnly||!/resource|campaign/g.test(e["new"].url)||e["new"].searchParams.has("s")||(e["new"].searchParams.append("s=email"),e.isLinkComplete())})}):(t.ctrlKey||t.metaKey)&&t.shiftKey&&49==t.which&&e.scope.$apply(function(){e.mapLinkObjects(function(t){return!!t.readOnly||(t["new"].searchParams["delete"]("o"),t["new"].searchParams["delete"]("oin"),t["new"].searchParams["delete"]("v"),t["new"].searchParams["delete"]("oiex"),t["new"].searchParams["delete"]("elqTrack"),t["new"].searchParams["delete"]("elqTrackId"),t["new"].searchParams["delete"]("s"),t["new"].searchParams["delete"]("s3"),EMLMakerAIEngine.emailAILastEval=0,t.isLinkComplete(),void e.areLinksComplete())})})}},e.prototype.replaceSpecialCharacters=function(e){var t={174:["&reg;"],169:["&copy;"],8211:["&ndash;"],8212:["&mdash;"],8220:["&ldquo;"],8221:["&rdquo;"],8216:["&lsquo;"],8217:["&rsquo;"],8482:["&trade;"]};for(var r in t)if(t.hasOwnProperty(r)){var i=new RegExp(String.fromCharCode(parseInt(r)),"g");i.test(e)&&(e=e.replace(i,t[r][0]))}return e},e.prototype.processHtml=function(){this.setUpShortcutKeys(),this.linkData=[],window.scrollTo(0,0);var e=this.replaceSpecialCharacters(this.sourceCode.replace(new RegExp("</a>","ig"),"</a>\n"));if(this.__emlHeaders=this.__buildHeaders(),"untitled"==this.fileName){var t=/<title>([^<].*?)<\/title>/gi;if(t.test(e)){var r=e.match(t);r.length>0&&(this.fileName=this.__formatFileName(r[0].replace(t,"$1")))}}var i=/<a\b[^>]*?>([\r\n]|.)*?<\/a>/gm;e=e.replace(i,function(e){return e.replace(new RegExp("\n|\t","g"),"")});for(var s=e.split("\n"),n=this,a=1,o=0;o<s.length;o++){var h=s[o].match(i);h&&h.forEach(function(e){if(/(href\=\"([^\"\>]*)\"?)/g.test(e)){var t=new LinkObject(o,e,n);t.id=a,t.readOnly=t["new"].contains(".com/e/es.aspx")&&t["new"].contains("~~eloqua"),n.linkData.push(t),a++}})}console.log("testing email"),EMLMakerAIEngine.resetCache(),this.mapLinkObjects(function(e){e.isLinkComplete()}),console.log(this.intelligence),location.href="#/links"},e.prototype.addNewHeaderField=function(e){this.header[e]=""},e.prototype.removeHeaderField=function(e){delete this.header[e]},e.prototype.isHeaderSelected=function(e){return!this.header.hasOwnProperty(e)||""==this.header},e.prototype.verifyLinkSectionComplete=function(){var e=!1;return e=(!this.linkData||0!=this.linkData.length)&&!!this.areLinksComplete()},e.prototype.generateOutputCode=function(){var e=this.replaceSpecialCharacters(this.sourceCode);e=e.replace(new RegExp("</a>","ig"),"</a>\n");var t=e.split("\n");this.mapLinkObjects(function(e){var r=e.line-1;if(void 0===t[r])return!1;if(e.whiteListedUrl==e["new"].url&&window.ga("send","event","Tracking-Optout","override",e["new"].url),e.hasOwnProperty("deleteOnRender")&&e.deleteOnRender){t[r].indexOf(e.context);t[r]=t[r].replace(new RegExp(e.context,"gi"),"")}else{var i=t[r].indexOf('href="'+e.old.url);t[r]=t[r].substr(0,i)+'href="'+e["new"].url+t[r].substr(i+6+e.old.url.length,t[r].length)}}),this.outputCode=t.join("\n"),this.outputCode=this.outputCode.replace(new RegExp("</a>\n","ig"),"</a>");try{this.outputCode=this.outputCode.replace(/<\/a>\n{0,5}(\.|,|\?|!|:|;|\|)/g,"</a>$1")}catch(r){console.log("error merging lines with links that previously had punctuation.")}},e.prototype.updateLinksAndExport=function(){return!!this.areLinksComplete()&&(location.href="#/export",window.scrollTo(0,0),!0)},e.prototype.areLinksComplete=function(){var e=!0;return this.mapLinkObjects(function(t){t.__isComplete||(e=!1),t.needsTrackingCode()&&(e=!1)}),e},e.prototype.getLinksSummary=function(){var e={needsTracking:0,invalidUrl:0};return this.mapLinkObjects(function(t){t.needsTrackingCode()&&e.needsTracking++,t.isLinkComplete()&&e.invalidUrl++}),e},e.prototype.importHtmlFromFileDrop=function(e){this.sourceCode.length>0&&(this.sourceCode=this.outputCode="");var t=e.dataTransfer.files;if(e.dataTransfer.files.length>1)alert("you can only import one file at at time.");else{var r=new FileReader,i=this;r.onloadend=function(e){var r=e.target.result,s=t[0].name.split("."),n=s.pop().toLowerCase();i.fileName=i.__formatFileName(s.join(".")),"eml"==n?i.sourceCode=i.__stripHtmlAndSubjectFromEML(r):i.sourceCode=r,i.processHtml(),location.href="#/links"},r.readAsText(t[0]),window.ga("send","event","HTML","import","HTML Import File Drop")}},e.prototype.__formatFileName=function(e){var t=/[^\w\s-]/g,r=/[-\s]+/g;return e=e.replace(t,"").trim().toLowerCase(),e=e.replace(r,"-")},e.prototype.__replaceEloquaMergeFields=function(e){var t=/<span(%20|\s)class="?eloquaemail"?\s?>(.*?)<\/span>/gi;return e=e.replace(t,"#$2#")},e.prototype.__stripHtmlAndSubjectFromEML=function(e){for(var t=e.split("\n"),r=t.pop(),i=0;i<t.length;i++)t[i].indexOf("Subject:")>-1&&void 0===this.header&&(this.header={});return r},e.prototype.__removeWhiteSpace=function(e){var t=e;return t=t.replace(new RegExp("\n","g")," "),t=t.replace(new RegExp("\t","g")," "),t=t.replace(/\s{2,99999}/g," ")},e.prototype.__buildHeaders=function(){for(var e=[],t=0;t<this.headers.length;t++)e.push(this.headers[t]);var r=this.__getCharsetFromHTML(this.sourceCode);""==r&&(r="charset=UTF-8"),e.push("Content-Type: text/html;\n\t"+r);for(var i in this.header)this.header.hasOwnProperty(i)&&this.__allowableHeaderFields.hasOwnProperty(i)&&e.push(this.__allowableHeaderFields[i].syntax+" "+this.header[i]);return this.__emlHeaders=e.join("\n"),e.join("\n")},e.prototype.__getCharsetFromHTML=function(e){var t=/<meta.*?charset=([^\s"]*)/gi,r="",i=e.match(t);return i&&i.forEach(function(e){var t=e.match(/charset=([^\s"]*)/gi);r=t?t[0]:"charset=UTF-8"}),r},e}();